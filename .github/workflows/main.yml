name: Sync Fork with Upstream

on:
  schedule:
    # Run at 9 AM and 9 PM IST (3:30 AM and 3:30 PM UTC due to India timezone)
    - cron: '30 3 * * *'   # 9 AM IST
    - cron: '30 15 * * *'  # 9 PM IST
  workflow_dispatch:        # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/coinbase/smart-wallet.git || true

      - name: Fetch upstream changes
        run: git fetch upstream main

      - name: Check for differences
        id: check_diff
        run: |
          DIFF=$(git diff main upstream/main --stat)
          if [ -z "$DIFF" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_diff.outputs.has_changes == 'true'
        uses: repo-sync/pull-request-action@v2
        with:
          source_branch: upstream/main
          destination_branch: main
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "ðŸ”„ chore: sync upstream changes - $(date +%d-%m-%Y)"
          pr_body: |
            ## Automated Upstream Sync
            
            This PR syncs the latest changes from the upstream repository:
            - **Upstream:** coinbase/smart-wallet
            - **Date:** $(date)
            
            ### What Changed
            - See commit history below
            
            **Created by:** GitHub Actions
